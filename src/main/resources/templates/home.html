<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Accueil - Gestion RH</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="home-page">
<!-- Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Main content -->
<div class="content">
    <!-- Bouton de connexion/d√©connexion en haut √† droite -->
    <div class="header-auth">
        <div sec:authorize="isAuthenticated()">
            <span class="auth-status">
                üë§ <span sec:authentication="name"></span>
            </span>
            <form th:action="@{/logout}" method="post" class="inline-form">
                <button type="submit" class="btn btn-logout">üö™ D√©connexion</button>
            </form>
        </div>
        <div sec:authorize="!isAuthenticated()">
            <a th:href="@{/login}" class="btn btn-login">üîê Se connecter</a>
        </div>
    </div>

    <!-- Message de bienvenue par d√©faut (affich√© uniquement si aucune section n'est active) -->
    <div th:if="${showEmployees == null or (!showEmployees and !showDashboard and !showStatistics and !showDepartements and !showProjets and !showFichesPaie)}" class="welcome-message">
        <h1>üè¢ Bienvenue dans le syst√®me de gestion RH</h1>
        <p>S√©lectionnez une option dans le menu de gauche pour commencer</p>
    </div>

    <!-- Section: Liste des employ√©s -->
    <div th:if="${showEmployees != null and showEmployees}">
        <div class="content-header">
            <h2>üìã Liste des employ√©s</h2>
        </div>

        <div class="header-actions" sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/employees}" class="btn btn-primary">
                ‚úèÔ∏è G√©rer les employ√©s (Ajouter/Modifier/Supprimer)
            </a>
        </div>

        <!-- Section Recherche et Filtres pour les employ√©s -->
        <div th:if="${employees != null && !employees.isEmpty()}" class="search-filter-section">
            <div class="search-box">
                <input type="text"
                       id="searchInputEmployees"
                       placeholder="üîç Rechercher un employ√© (nom, pr√©nom, email, poste, matricule...)"
                       autocomplete="off">
            </div>
            <div id="filterContainerEmployees"></div>
        </div>

        <div th:if="${employees != null && !employees.isEmpty()}">
            <table id="employeesTableHome">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Matricule</th>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Poste</th>
                    <th>Grade</th>
                    <th>Salaire</th>
                    <th>Date Embauche</th>
                    <th>D√©partement</th>
                    <th>Role</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="employee : ${employees}">
                    <td th:text="${employee.id}"></td>
                    <td th:text="${employee.matricule}"></td>
                    <td th:text="${employee.nom}"></td>
                    <td th:text="${employee.prenom}"></td>
                    <td th:text="${employee.email}"></td>
                    <td th:text="${employee.telephone}"></td>
                    <td th:text="${employee.poste}"></td>
                    <td th:text="${employee.grade}"></td>
                    <td th:text="${employee.salaireBase}"></td>
                    <td th:text="${employee.dateEmbauche}"></td>
                    <td th:text="${employee.idDepartement}"></td>
                    <td th:text="${employee.role}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${employees == null || employees.isEmpty()}" class="dashboard-card">
            <p class="text-center">Aucun employ√© trouv√© dans la base de donn√©es.</p>
        </div>
    </div>

    <!-- Section: Dashboard -->
    <div th:if="${showDashboard != null and showDashboard}">
        <div class="content-header">
            <h2>üìä Tableau de bord</h2>
        </div>

        <div class="dashboard-card">
            <h3>Nombre total d'employ√©s</h3>
            <div class="stat-number" th:text="${employeeCount}">0</div>
        </div>

        <div class="dashboard-card">
            <h3>Statistiques g√©n√©rales</h3>
            <p>Bienvenue sur votre tableau de bord. Vous pouvez visualiser ici les indicateurs cl√©s de votre entreprise.</p>
        </div>
    </div>

    <!-- Section: Statistiques -->
    <div th:if="${showStatistics != null and showStatistics}">
        <div class="content-header">
            <h2>üìà Statistiques & Rapports</h2>
        </div>

        <!-- Statistiques g√©n√©rales -->
        <div class="stats-grid">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${totalEmployees}">0</div>
                    <div class="stat-label">Employ√©s</div>
                </div>
            </div>

            <div class="stat-card stat-card-green">
                <div class="stat-icon">üìÅ</div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${totalProjets}">0</div>
                    <div class="stat-label">Projets</div>
                </div>
            </div>

            <div class="stat-card stat-card-purple">
                <div class="stat-icon">üèõÔ∏è</div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${totalDepartements}">0</div>
                    <div class="stat-label">D√©partements</div>
                </div>
            </div>
        </div>

        <!-- Rapport: Employ√©s par d√©partement -->
        <div class="dashboard-card">
            <h3>üë• Employ√©s par d√©partement</h3>
            <div class="chart-container">
                <table class="stats-table">
                    <thead>
                    <tr>
                        <th>D√©partement</th>
                        <th>Nombre d'employ√©s</th>
                        <th>Visualisation</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${employeesPerDepartment}">
                        <td th:text="${entry.key}"></td>
                        <td th:text="${entry.value}"></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill"
                                     th:style="'width: ' + ${entry.value * 100.0 / totalEmployees} + '%'"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rapport: Employ√©s par grade -->
        <div class="dashboard-card">
            <h3>üéì Employ√©s par grade</h3>
            <div class="chart-container">
                <table class="stats-table">
                    <thead>
                    <tr>
                        <th>Grade</th>
                        <th>Nombre d'employ√©s</th>
                        <th>Pourcentage</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${employeesPerGrade}">
                        <td th:text="${entry.key}"></td>
                        <td th:text="${entry.value}"></td>
                        <td>
                            <span class="badge badge-info"
                                  th:text="${#numbers.formatDecimal(entry.value * 100.0 / totalEmployees, 1, 1) + '%'}"></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rapport: √âtat des projets -->
        <div class="dashboard-card">
            <h3>üìä √âtat des projets</h3>
            <div class="chart-container">
                <table class="stats-table">
                    <thead>
                    <tr>
                        <th>√âtat</th>
                        <th>Nombre de projets</th>
                        <th>Visualisation</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${projetsPerEtat}">
                        <td>
                            <span th:if="${entry.key == 'EN_COURS'}" class="badge-success">‚è≥ EN COURS</span>
                            <span th:if="${entry.key == 'TERMINE'}" class="badge-info">‚úÖ TERMIN√â</span>
                            <span th:if="${entry.key == 'ANNULE'}" class="badge-danger">‚ùå ANNUL√â</span>
                        </td>
                        <td th:text="${entry.value}"></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill"
                                     th:classappend="${entry.key == 'EN_COURS' ? 'progress-green' : (entry.key == 'TERMINE' ? 'progress-blue' : 'progress-red')}"
                                     th:style="'width: ' + ${entry.value * 100.0 / totalProjets} + '%'"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rapport: Employ√©s par projet -->
        <div class="dashboard-card">
            <h3>üìÅ Employ√©s affect√©s par projet</h3>
            <div class="chart-container">
                <table class="stats-table">
                    <thead>
                    <tr>
                        <th>Projet</th>
                        <th>Nombre d'employ√©s affect√©s</th>
                        <th>Visualisation</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="entry : ${employeesPerProjet}">
                        <td th:text="${entry.key}"></td>
                        <td th:text="${entry.value}"></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill progress-purple"
                                     th:style="'width: ' + ${entry.value > 0 ? (entry.value * 10) : 0} + '%'"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section: Liste des d√©partements -->
    <div th:if="${showDepartements != null and showDepartements}">
        <div class="content-header">
            <h2>üèõÔ∏è Liste des d√©partements</h2>
        </div>

        <div class="header-actions" sec:authorize="hasAnyRole('ADMIN', 'CHEF_DEPT')">
            <a th:href="@{/departements}" class="btn btn-primary">
                ‚úèÔ∏è G√©rer les d√©partements (Ajouter/Modifier/Supprimer)
            </a>
        </div>

        <!-- Section Recherche et Filtres pour les d√©partements -->
        <div th:if="${departements != null && !departements.isEmpty()}" class="search-filter-section">
            <div class="search-box">
                <input type="text"
                       id="searchInputDepartements"
                       placeholder="üîç Rechercher un d√©partement (intitul√©, chef...)"
                       autocomplete="off">
            </div>
            <div id="filterContainerDepartements"></div>
        </div>

        <div th:if="${departements != null && !departements.isEmpty()}">
            <table id="departementsTableHome">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Intitul√©</th>
                    <th>Chef de d√©partement (ID)</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="departement : ${departements}">
                    <td th:text="${departement.id}"></td>
                    <td th:text="${departement.intitule}"></td>
                    <td th:text="${departement.chefDepartement}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${departements == null || departements.isEmpty()}" class="dashboard-card">
            <p class="text-center">Aucun d√©partement trouv√© dans la base de donn√©es.</p>
        </div>
    </div>

    <!-- Section: Liste des projets -->
    <div th:if="${showProjets != null and showProjets}">
        <div class="content-header">
            <h2>üìÅ Liste des projets</h2>
        </div>

        <div class="header-actions" sec:authorize="hasAnyRole('ADMIN', 'CHEF_DEPT', 'CHEF_PROJET')">
            <a th:href="@{/projets}" class="btn btn-primary">
                ‚úèÔ∏è G√©rer les projets (Ajouter/Modifier/Supprimer)
            </a>
        </div>

        <!-- Section Recherche et Filtres pour les projets -->
        <div th:if="${projets != null && !projets.isEmpty()}" class="search-filter-section">
            <div class="search-box">
                <input type="text"
                       id="searchInputProjets"
                       placeholder="üîç Rechercher un projet (nom, chef, d√©partement...)"
                       autocomplete="off">
            </div>
            <div id="filterContainerProjets"></div>
        </div>

        <div th:if="${projets != null && !projets.isEmpty()}">
            <table id="projetsTableHome">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom du projet</th>
                    <th>√âtat</th>
                    <th>Date d√©but</th>
                    <th>Date fin pr√©vue</th>
                    <th>Chef de projet</th>
                    <th>D√©partement</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="projet : ${projets}">
                    <td th:text="${projet.id}"></td>
                    <td th:text="${projet.nomProjet}"></td>
                    <td th:text="${projet.etatProjet}"></td>
                    <td th:text="${projet.dateDebut}"></td>
                    <td th:text="${projet.dateFinPrevue}"></td>
                    <td>
                        <span th:if="${projet.chefProjet != null}">
                            <span th:each="emp : ${employees}">
                                <span th:if="${emp.id == projet.chefProjet}"
                                      th:text="${emp.prenom + ' ' + emp.nom}"></span>
                            </span>
                        </span>
                        <span th:if="${projet.chefProjet == null}">-</span>
                    </td>
                    <td>
                        <span th:if="${projet.idDepartement != null}">
                            <span th:each="dept : ${departements}">
                                <span th:if="${dept.id == projet.idDepartement}"
                                      th:text="${dept.intitule}"></span>
                            </span>
                        </span>
                        <span th:if="${projet.idDepartement == null}">-</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${projets == null || projets.isEmpty()}" class="dashboard-card">
            <p class="text-center">Aucun projet trouv√© dans la base de donn√©es.</p>
        </div>
    </div>

    <!-- Section: Liste des fiches de paie -->
    <div th:if="${showFichesPaie != null and showFichesPaie}">
        <div class="content-header">
            <h2>üí∞ Liste des fiches de paie</h2>
        </div>

        <div class="header-actions" sec:authorize="hasAnyRole('ADMIN', 'CHEF_DEPT')">
            <a th:href="@{/fiches-paie}" class="btn btn-primary">
                ‚úèÔ∏è G√©rer les fiches de paie (Ajouter/Modifier/Supprimer)
            </a>
        </div>

        <!-- Section Recherche et Filtres pour les fiches de paie -->
        <div th:if="${fichesPaie != null && !fichesPaie.isEmpty()}" class="search-filter-section">
            <div class="search-box">
                <input type="text"
                       id="searchInputFichesPaie"
                       placeholder="üîç Rechercher une fiche de paie (employ√©, mois, ann√©e...)"
                       autocomplete="off">
            </div>
            <div id="filterContainerFichesPaie"></div>
        </div>

        <div th:if="${fichesPaie != null && !fichesPaie.isEmpty()}">
            <table id="fichesPaieTableHome">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Employ√©</th>
                    <th>P√©riode</th>
                    <th>Salaire base</th>
                    <th>Primes</th>
                    <th>D√©ductions</th>
                    <th>Net √† payer</th>
                    <th>Date g√©n√©ration</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="fiche : ${fichesPaie}">
                    <td th:text="${fiche.id}"></td>
                    <td>
                        <span th:if="${fiche.idEmployer != null}">
                            <span th:each="emp : ${employees}">
                                <span th:if="${emp.id == fiche.idEmployer}"
                                      th:text="${emp.prenom + ' ' + emp.nom}"></span>
                            </span>
                        </span>
                        <span th:if="${fiche.idEmployer == null}">-</span>
                    </td>
                    <td th:text="${fiche.mois + '/' + fiche.annee}"></td>
                    <td th:text="${fiche.salaireBase + ' ‚Ç¨'}"></td>
                    <td th:text="${fiche.primes + ' ‚Ç¨'}"></td>
                    <td th:text="${fiche.deductions + ' ‚Ç¨'}"></td>
                    <td class="highlight-amount" th:text="${fiche.netAPayer + ' ‚Ç¨'}"></td>
                    <td th:text="${fiche.dateGeneration}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${fichesPaie == null || fichesPaie.isEmpty()}" class="dashboard-card">
            <p class="text-center">Aucune fiche de paie trouv√©e dans la base de donn√©es.</p>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:src="@{/js/search-filters.js}"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les filtres pour la section Employ√©s
        const tableEmployees = document.getElementById('employeesTableHome');
        const searchInputEmployees = document.getElementById('searchInputEmployees');
        const filterContainerEmployees = document.getElementById('filterContainerEmployees');

        if (tableEmployees && searchInputEmployees && filterContainerEmployees) {
            initTableSearchFilter('employeesTableHome', 'searchInputEmployees', 'filterContainerEmployees');
        }

        // Initialiser les filtres pour la section D√©partements
        const tableDepartements = document.getElementById('departementsTableHome');
        const searchInputDepartements = document.getElementById('searchInputDepartements');
        const filterContainerDepartements = document.getElementById('filterContainerDepartements');

        if (tableDepartements && searchInputDepartements && filterContainerDepartements) {
            initTableSearchFilter('departementsTableHome', 'searchInputDepartements', 'filterContainerDepartements');
        }

        // Initialiser les filtres pour la section Projets
        const tableProjets = document.getElementById('projetsTableHome');
        const searchInputProjets = document.getElementById('searchInputProjets');
        const filterContainerProjets = document.getElementById('filterContainerProjets');

        if (tableProjets && searchInputProjets && filterContainerProjets) {
            initTableSearchFilter('projetsTableHome', 'searchInputProjets', 'filterContainerProjets');
        }

        // Initialiser les filtres pour la section Fiches de paie
        const tableFichesPaie = document.getElementById('fichesPaieTableHome');
        const searchInputFichesPaie = document.getElementById('searchInputFichesPaie');
        const filterContainerFichesPaie = document.getElementById('filterContainerFichesPaie');

        if (tableFichesPaie && searchInputFichesPaie && filterContainerFichesPaie) {
            initTableSearchFilter('fichesPaieTableHome', 'searchInputFichesPaie', 'filterContainerFichesPaie');
        }
    });
</script>
</body>
</html>